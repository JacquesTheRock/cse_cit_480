  <div class="container" style="max-width: 750px;">
	<!--<div class="col-sm-offset-1 col-sm-10 col-sm-offset-1">-->
	<h2 id="idHeader" class="header contentbox-header" style="max-width: 750px;">Cross: <a id="editButton" data-toggle="modal" data-target="#editCrossModal">
		<span class="pull-right">
				<span class="glyphicon glyphicon-edit">
				</span>

		</span></a>
	</h2>
	  <div class="contentbox">
		<div class="container-fluid">
		  <!--Adds style color to "User Profile"-->
		  <br>
		  
		  <section class="row container-fluid">
			<!-- Fetches and displays the user profile image -->
			<div class="col-sm-6 col-md-6 col-lg-6" style ="float: center;" id="parent1"><p><h2>Parent 1</h2></p><a href=""><img id="p1image" src="/static/media/flower.png" width="200" height="200" alt="Parent Picture"></a></div>
			<div class="col-sm-6 col-md-6 col-lg-6" style ="float: center;" id="parent2"><p><h2>Parent 2</h2></p><a href=""><img id="p2image" src="/static/media/flower.png" width="200" height="200" alt="Parent Picture"></a></div>
		  </section>
		  
		  <section class="row-fluid">
			<h2 id="nameHeader" >Cross Name: BLA BLA BLA</h2>
		  </section>
		  <section class="row-fluid">
			<h3>
				<b>
					TreeView
				</b>
			</h3>
			  <canvas id="tree" width="500" height="200"></canvas>

	   
		  </section>
		  
		  <section id="traitPool" class="row-fluid">
			<h3><b>Trait Pool and Percentages</b></h3>
			This Cross has no Parents with Traits
		  </section>
		  

		  <section class="row-fluid">
			<h3><b>Cross Notes</b></h3>
			<p id="crossNote"></p><br>
		  </section>
		  
		  <section class="row-fluid">
			<h3><b><div style="max-width: 230px;">Child Candidates<a id="newCN" class="glyphicon glyphicon-plus pull-right" href="newcandidate.html"></a></div></b></h3>
			<ul id="candidateList"></ul>
		  </section>
		  
		</div>
	  </div>
	  
	  
	  
	  
	<!-- edit page pop up content start-->
	<div id="editCrossModal" class="modal fade" role="dialog">
		<div class="modal-dialog">

		<!-- Modal content-->

				  <div class="contentbox">
					<div class="container-fluid">
					  <div id="result"></div>
					  
						<div class="form-group">
							<label for="crossname">Cross Name</label>
							<input type="text" class="form-control" id="submitCrossname" placeholder="Give your cross a custom name!">
						</div>
					  
						<div class="form-group">
							<label for="notes">Cross Notes</label>
							<input type="text" class="form-control" id="submitNotes" placeholder="Write notes about your cross!">
						</div>
						
						<button onclick="UpdateCross()" class="btn btn-default">Update</button>
			
					</div>
				  </div>


		</div>
	</div>
	<!-- edit page pop up content stop-->
  </div>
<script>
var pid = getParameterByName("pid");
var cid = getParameterByName("id");
{
var newCN = document.getElementById("newCN");
newCN.href += "?pid=" + pid + "&cid=" + cid
}
var crossProfile
var editButton = document.getElementById("editButton");
var idHeader = document.getElementById("idHeader")
idHeader.innerHTML = "Cross"

function getParameterByName(name, url) {
	if (!url) {
	  url = window.location.href;
	}
	name = name.replace(/[\[\]]/g, "\\$&");
	var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
		results = regex.exec(url);
	if (!results) return null;
	if (!results[2]) return '';
	return decodeURIComponent(results[2].replace(/\+/g, " "));
}

function UpdateCross() {
	var name = document.getElementById("submitCrossname");
	var note = document.getElementById("submitNotes");
	var url = "http://bloomgenetics.tech/api/v1/projects/" + pid + "/crosses/" + cid; 
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
	}
	xhttp.open("PUT", url, true);
	if(localStorage["Authorization"])
		xhttp.setRequestHeader("Authorization", localStorage["Authorization"])
	xhttp.setRequestHeader("Content-type", "application/json");
	crossProfile.description = note;
	crossProfile.name = name;
	xhttp.send(JSON.stringify(crossProfile));
}

var parent1ID = 0
var parent2ID = 0
function updateCrossInfo() {
	if(this.readyState == 4 && this.status == 200) {
		var out = JSON.parse(this.responseText)
		if(out.code == 400)
			errorField.innerHTML = "Unable to view cross: Access Denied"
		else if (out.code != 0)
			errorField.innerHTML = out.status
		else {
			var d = out.data
			crossProfile = d.data
			idHeader.innerHTML = "Cross: " + d.data.id
			document.getElementById("nameHeader").innerHTML = "Cross Name: " + d.data.name
			document.getElementById("crossNote").innerHTML = d.data.description
			if(d.data.parent1 == 0)
				document.getElementById("parent1").outerHTML = ""
			else if(d.parents.length > 0) {
				var p
				if (d.parents.length == 2 && d.parents[1].id == d.data.parent1)
					p = d.parents[1].data.id
				else
					p = d.parents[0].data.id
				var p1I = document.getElementById("p1image")
				p1I.parentNode.href = "/candidate.html?pid="+pid+"&cid="+p+"&id="+d.data.parent1
				getTraits(p, d.data.parent1)
				parent1ID = d.data.parent1
			}
			if(d.data.parent2 == 0)
				document.getElementById("parent2").outerHTML = ""
			else if(d.parents.length > 0) {
				var p
				if (d.parents.length == 2 && d.parents[1].id == d.data.parent2)
					p = d.parents[1].data.id
				else
					p = d.parents[0].data.id
				var p2I = document.getElementById("p2image")
				p2I.parentNode.href = "/candidate.html?pid="+pid+"&cid="+p+"&id="+d.data.parent2
				getTraits(p, d.data.parent2)
				parent2ID = d.data.parent2
			}
			getCandidateList();
		}
	}
}

var allTraits = []
var map = []
function updateTraitInfo() {
	if(this.readyState == 4 && this.status == 200) {
		var out = JSON.parse(this.responseText)
		if(out.code == 400)
			errorField.innerHTML = "Not Allowed to view trait info"
		else if (out.code != 0)
			errorField.innerHTML = out.status
		else {
			var poolEl = document.getElementById("traitPool")
			var poolInner = "<h3><b>Trait Pool and Percentages</b></h3><table border='2' cellpadding='5'><th>type</th><th>Name</th><th>Carrier</th><th>Shows</th>"
			var d = out.data
		/*Code to set up image */
			var elID = "p1image"
			if(d.id == parent2ID)
				elID = "p2image"
			if(d.imageId == 0) {
				var el = document.getElementById(elID)
				el.src = "/static/media/flower.png"
			}
			else
				getCandidateImage(d.imageId, elID)
		/* end image setup */
			if(!d.traits)
				return 
			for(t of d.traits) {
				if(!allTraits[t.pool])
					allTraits[t.pool] = []
				var pool = allTraits[t.pool]
				pool[pool.length] = t
				if(!map[t.id])
					map[t.id] = t
			}
			for (var i = 1; i < allTraits.length; i++) { // for each pool
				var pool = allTraits[i]
				for (t of pool) {
					var tmp = map[t.id];
					if(d.id == parent1ID)
						tmp.p1count = (tmp.p1count || 0) + 1
					if(d.id == parent2ID)
						tmp.p2count = (tmp.p2count || 0) + 1
					var shows = 0;
					var carrier = 0;
					var p1Traits = 0
					var p2Traits = 0
					if(tmp.p1count)
						p1Traits = 1
					if(tmp.p2count)
						p2Traits = 1
					for(j of pool) {
						if(tmp.id == j.id)
							continue
						if(j.p1count)
							p1Traits += 1
						if(j.p2count)
							p2Traits += 1
					}
					if(parent1ID > 0 && parent2ID > 0 && parent1ID != parent2ID) {
						if((tmp.p1count && p1Traits == 1)||(tmp.p2count && p2Traits == 1)) {
							carrier = 100
						} else if(p1Traits == 2 &&  p2Traits == 2) {
							carrier = 75
						} else {
							carrier = 50
						}
	
						if(tmp.type_id == 2) {
							shows = carrier
						} else if (tmp.type_id == 1) {
							if(pool.length == 1)
								shows = 100
							else if(pool.length == 2)
								if (tmp.p1count && tmp.p2count && (p1Traits != 2 || p1Traits != 2))
									shows = 50
								else if (tmp.p1count && tmp.p2count)
									shows = 25
								else
									shows = 0
								
						}
					} else {
						if(pool.length == 1)
							carrier = 100
						else
							carrier = 75
						if(tmp.type_id == 2)
							shows = carrier
						else {
							if(pool.length == 2)
								shows = 25
							else if(pool.length == 1)
								shows = 100
							else
								shows = 0
						}
					}
					
					poolInner += "<tr><td>"+tmp.type+"</td><td>"+tmp.name + "</td><td>" + carrier + "%</td><td>" + shows +"%</td></tr>"
				}
			}
		}
		poolInner += "</table>"
		poolEl.innerHTML = poolInner
	}
}

function updateCandidateList() {
	if(this.readyState == 4 && this.status == 200) {
		var out = JSON.parse(this.responseText)
		if(out.code == 400)
			errorField.innerHTML = "Not Allowed to view candidates"
		else if (out.code != 0)
			errorField.innerHTML = out.status
		else {
			var listEl = document.getElementById("candidateList")
			if (out.data) {
				for (s of out.data) {
					var li = "<li><a href='candidate.html?pid=" + pid
					li += "&cid=" + cid + "&id=" + s.id +"'>"
					li += "Link to Candidate: " + s.id
					li += "</a></li>"
					listEl.innerHTML += li;
				}
			}
		}
	}	
}


function makeImageFunc(elID) {
	return function () {
		if(this.readyState == 4 && this.status == 200) {
                	var out = JSON.parse(this.responseText)
                	if(out.code == 400)
                	        errorField.innerHTML = "Not allowed to view image"
                	else if (out.code != 0)
                	        errorField.innerHTML = out.status
                	else {
                	        var el = document.getElementById(elID)
                	        el.src = out.data.data
                	}
		}
	}
}
function getCandidateImage(iid,elID) {
	var url = "http://bloomgenetics.tech/api/v1/images/" + iid
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = makeImageFunc(elID);
        xhttp.open("GET", url, true);
        if(localStorage["Authorization"])
                xhttp.setRequestHeader("Authorization", localStorage["Authorization"])
        xhttp.send(null)
}

function getTraits(pcid,p) {
	var url = "http://bloomgenetics.tech/api/v1/projects/" + pid + "/crosses/" + pcid + "/candidates/" + p
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = updateTraitInfo;
	xhttp.open("GET", url, true);
	if(localStorage["Authorization"])
		xhttp.setRequestHeader("Authorization", localStorage["Authorization"])
	xhttp.send(null)
}

function getCrossInfo() {
	var url = "http://bloomgenetics.tech/api/v1/projects/" + pid + "/treview/" + cid;
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = updateCrossInfo;
	xhttp.open("GET", url, true);
	if(localStorage["Authorization"])
		xhttp.setRequestHeader("Authorization", localStorage["Authorization"])
	xhttp.send(null)
}

function getCandidateList() {
	var url = "http://bloomgenetics.tech/api/v1/projects/" + pid + "/crosses/" + cid + "/candidates"
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = updateCandidateList;
	xhttp.open("GET", url, true);
	if(localStorage["Authorization"])
		xhttp.setRequestHeader("Authorization", localStorage["Authorization"])
	xhttp.send(null)
		
}

getCrossInfo();
</script>
<script>
function getData() {
	if(this.readyState == 4 && this.status == 200) {
		errdiv = document.getElementById("error");	
		var resp = JSON.parse(this.responseText)
		if (resp.code != 0) {
			errdiv.innerHTML = "Unable to load treeview for Project " +
				pid + " because:<br> " +
				resp.status;
		}
		if (resp.data == null)
			return
		var roots = [resp.data];
		resp.data.type = "current"
		if (resp.data && resp.data.parents ) {
			roots = resp.data.parents
			for (r of roots) {
				r.type = "parent"
				r.children = [resp.data]
			}
		}
		for (r of roots) {
			trees[trees.length] = new Tree(r);
		}
		draw();
	}
}

var trees = [];
var nodes = [];
var canvas = null;
var ctx = null;
var camera_pos = {x:250,y:125}
function Tree(r, l = 0) {
	this.el = {
		pos: {x: 0, y: 0},
		id: r.data.id,
		r: 15,
		project: r.data.projectId,
		name: r.data.name,
		type: r.type,
		children: [],
		layer: l
	};
	nodes[nodes.length] = this.el
	if(this.el.type != 'current')
		this.el.onclick = clickNode
	this.drawNode = drawNode
	if (!r.children) 
		return;
	for( c of r.children) {
		this.el.children[this.el.children.length] = new Tree(c,l+1);
	}
}

function clickNode() {
	window.location = "/cross.html?id=" + this.id + "&pid=" + pid
}

function max(a,b) {
	if(a < b)
		return b
	else
		return a
}

function drawNode(pos) {
	ctx.beginPath();
	this.el.pos.x = pos.x;
	this.el.pos.y = pos.y;
	ctx.lineWidth=2;
	ctx.stroke();
	ctx.closePath();
	var twidth = ctx.measureText(this.el.name + "").width
	ctx.save();
	if(this.el.type  != "current") {
		var xscale = 1
		if((twidth / 2) + 3 > this.el.r)
			xscale = (twidth/2 + 3)/this.el.r;
		var ixscale = 1/xscale
		ctx.scale(xscale, 1)
		ctx.arc(this.el.pos.x * ixscale, this.el.pos.y, this.el.r, 0,  2 * Math.PI);
	} else {
		var width = max(this.el.r - 5, twidth /2 + 3 )
		ctx.rect(this.el.pos.x - width, this.el.pos.y - this.el.r, width * 2, this.el.r * 2);
	}
	ctx.stroke();
	ctx.restore();
	ctx.lineWidth=1;
	ctx.strokeText(this.el.name,pos.x - twidth/2,pos.y+4)
	if (!this.el.children)
		return;
	var offset = { x: pos.x, y: pos.y }
	offset.x -= (this.el.children.length * 15);
	offset.y = pos.y - 50;
	for (c of this.el.children) {
		c.drawNode(offset);
		ctx.moveTo(this.el.pos.x,this.el.pos.y - this.el.r);
		ctx.lineWidth=1;
		ctx.lineTo(offset.x,offset.y + this.el.r);
		ctx.stroke();
		offset.x += 60;
	}
}

prevMouse = {x:0,y:0}
var clicked = false
var dragged = false
function mouseDrag(e) {
	var rect = canvas.getBoundingClientRect();
	var mousePos = {
		x: e.clientX - rect.left,
		y: e.clientY - rect.top
	}
	if (clicked) {
		dragged = true;
		delta = {
			x: mousePos.x - prevMouse.x,
			y: mousePos.y - prevMouse.y
		}
		camera_pos.x += delta.x * 0.7
		camera_pos.y += delta.y * 0.7
		ctx.clearRect(0,0,canvas.width,canvas.height);
		draw();
	}
	prevMouse.x = mousePos.x
	prevMouse.y = mousePos.y
	
}

function mouseClick(e) {
	var rect = canvas.getBoundingClientRect();
	var mousePos = {
		x: e.clientX - rect.left,
		y: e.clientY - rect.top
	}
	var clickPos = {
		x: mousePos.x,// - camera_pos.x,
		y: mousePos.y// - camera_pos.y
	}
	for(var i = 0; i < nodes.length; i++) {
		var node = nodes[i]
		var xSq = (clickPos.x - node.pos.x)
		xSq *= xSq
		var ySq = (clickPos.y - node.pos.y)
		ySq *= ySq
		if(xSq + ySq < node.r * node.r)
			node.onclick()
		
	}
}


function begin() {
	canvas = document.getElementById("tree");	
	canvas.addEventListener('mousemove', mouseDrag, false);
	canvas.addEventListener('mousedown', function(e) {clicked = true;dragged=false;}, false);
	canvas.addEventListener('mouseup', function(e) {
			clicked = false;
			if (!dragged)
				mouseClick(e)
			dragged=false;
		}, false);
	ctx = canvas.getContext("2d");
	ctx.font = "8pt Courier"
	var URL = "http://bloomgenetics.tech/api/v1";
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = getData;
	xhttp.open("GET", URL + "/projects/" + pid + "/treview/" + cid, true);
	if (localStorage.getItem("Authorization")) {
		xhttp.setRequestHeader("Authorization", localStorage["Authorization"]);
	}
	xhttp.send(null);
}

function draw() {
	if (trees.length == 0)
		return
	offset = {
		x: camera_pos.x,
		y: camera_pos.y
		}
	for (r of trees) {
		r.drawNode(offset)
		offset.x += 100
	}
}
window.onload = begin
</script>
